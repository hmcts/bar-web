#!groovy

@Library("Infrastructure")

def product = "bar"
def component = "web"

List<LinkedHashMap<String, Object>> secrets = [
  secret('bar-IDAM-CLIENT-SECRET', 'IDAM_CLIENT_SECRET'),
]

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [ $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    version: '',
    envVariable: envVar
  ]
}

withPipeline("nodejs", product, component) {

  //setVaultName('bar')
  //loadVaultSecrets(secrets)
  enableDockerBuild()
  installCharts()
  enableSlackNotifications('#bar-tech')

  before('smoketest:aks') {
    // workaround to fix SIDAM whitelisting for PR AKS URLs
    try {
      def encodedServiceName = 'Money%20Claims%20-%20Citizen'
      def aksUrlToWhitelist = env.TEST_URL + '/oauth2/callback'
      sh('curl -X PATCH https://idam-api.aat.platform.hmcts.net/testing-support/services/BAR' +
        ' -H \'Content-Type: application/json\'' +
        ' -H \'cache-control: no-cache\'' +
        ' -d \'[{' +
        '"operation":"add",' +
        '"field":"redirect_uri",' +
        '"value":"' + aksUrlToWhitelist + '"' +
        '}]\'')
    } catch (err) {
      notifyBuildEvent channel: notificationsChannel, color: 'warning', message: 'Failed to update SIDAM PR whitelisting'
    }
  }

  after('checkout') {
    sh "yarn cache clean"
    echo 'bar-web checked out'
  }
  after('build') {
    sh 'yarn ng:build'
  }

}
